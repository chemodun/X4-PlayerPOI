<?xml version="1.0" encoding="utf-8"?>
<mdscript name="Player_POI_Interface" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <cues>

    <cue name="Main" version="1">
      <actions>
        <set_value name="$isInitializedAt" exact="null" />
        <set_value name="$debugChance" exact="0" />
      </actions>
      <cues>
        <cue name="On_Reload" instantiate="true" version="1">
          <conditions>
            <check_any>
              <event_cue_signalled cue="md.Interact_Menu_API.Reloaded" />
              <event_ui_triggered screen="'PlayerPoi'" control="'Reloaded'" />
              <event_game_loaded />
            </check_any>
          </conditions>
          <actions>
            <include_actions ref="Get_Variables" />
            <do_if value="not $isInitializedAt? or (player.age - $isInitializedAt) gt 10">
              <set_value name="$isInitializedAt" exact="player.age" />
              <reset_cue cue="this" />
            </do_if>
          </actions>
        </cue>

        <library name="Get_Variables" version="2">
          <actions>
            <do_if value="@player.entity.$playerPoi == null">
              <set_value name="player.entity.$playerPoi" exact="table[
                $assignAbandoned = false,
                $assignAbandonedNoClaim = false,
                $assignLockboxes = false,
                $assignHiddenAll = false,
                $debugLevel = 'none',
                $optimizeRename = true
                ]" />
            </do_if>
            <do_if value="@player.entity.$playerPoi.$assignAbandoned == null">
              <set_value name="player.entity.$playerPoi.$assignAbandoned" exact="false" />
            </do_if>
            <do_if value="@player.entity.$playerPoi.$assignAbandonedNoClaim == null">
              <set_value name="player.entity.$playerPoi.$assignAbandonedNoClaim" exact="false" />
            </do_if>
            <do_if value="@player.entity.$playerPoi.$assignLockboxes == null">
              <set_value name="player.entity.$playerPoi.$assignLockboxes" exact="false" />
            </do_if>
            <do_if value="@player.entity.$playerPoi.$assignHiddenAll == null">
              <set_value name="player.entity.$playerPoi.$assignHiddenAll" exact="false" />
            </do_if>
            <set_value name="$debugChance" exact="if @player.entity.$playerPoi.$debugLevel == null or @player.entity.$playerPoi.$debugLevel == 'none' then 0 else 100" />
            <set_value name="$poiDistanceAdditive" exact="20m" />
            <set_value name="$poiDistanceThresholdAdditive" exact="30m" />
            <set_value name="$poiObjectMinRadius" exact="150m" />
          </actions>
        </library>

        <cue name="On_Debug_Level_Changed" instantiate="true" version="1">
          <conditions>
            <event_object_signalled object="player.entity" param="'PlayerPoi.DebugLevelChangedSignal'" />
          </conditions>
          <actions>
            <include_actions ref="Get_Variables" />
            <debug_text text="'PlayerPoi Options: Debug Level changed to %s' .[@player.entity.$playerPoi.$debugLevel]" context="false" filter="scripts" chance="$debugChance" />
          </actions>
        </cue>

        <cue name="Add_Menu_Actions" instantiate="true" version="1">
          <conditions>
            <event_cue_signalled cue="md.Interact_Menu_API.Get_Actions" />
            <check_value value="@player.holomap.isopen or @event.param.$showPlayerInteractions" />
            <check_value value="event.param.$object? and @event.param.$object != null" />
            <set_value name="$sector" exact="null" />
            <set_value name="$poi" exact="null" />
            <check_value value="@event.param.$selectedplayerships.count == null or @event.param.$selectedplayerships.count == 0 or @event.param.$selectedplayerships.count == 1 and @event.param.$showPlayerInteractions == 1" />
            <check_any>
              <check_all>
                <check_value value="@event.param.$selectedotherobjects.count == null or @event.param.$selectedotherobjects.count == 0" />
                <check_value value="@event.param.$selectedplayerdeployables.count == null or @event.param.$selectedplayerdeployables.count == 0" />
                <check_value value="@event.param.$object.isclass.{class.sector}" />
                <check_value value="@event.param.$offsetcomponent == @event.param.$object" />
                <set_value name="$sector" exact="@event.param.$object" />
              </check_all>
              <check_all>
                <check_value value="@event.param.$selectedotherobjects.count == null or @event.param.$selectedotherobjects.count == 0" />
                <check_value value="@event.param.$selectedplayerdeployables.count == null or @event.param.$selectedplayerdeployables.count == 0 or @event.param.$selectedplayerdeployables.count == 1 and @event.param.$selectedplayerdeployables.indexof.{@event.param.$object} gt 0" />
                <check_value value="@event.param.$object.isclass.{class.navbeacon}" />
                <check_value value="@event.param.$object.macro == macro.player_poi_01_macro" />
                <set_value name="$poi" exact="@event.param.$object" />
              </check_all>
              <check_all>
                <check_value value="@event.param.$selectedotherobjects.count == null or @event.param.$selectedotherobjects.count == 0 or @event.param.$selectedotherobjects.count == 1 and @event.param.$selectedotherobjects.indexof.{@event.param.$object} gt 0" />
                <check_value value="@event.param.$selectedplayerdeployables.count == null or @event.param.$selectedplayerdeployables.count == 0" />
                <check_value value="@event.param.$object.owner != faction.player" />
                <check_any>
                  <check_value value="@event.param.$object.isclass.{class.station}" />
                  <check_value value="@event.param.$object.isclass.{class.gate}" />
                </check_any>
              </check_all>
            </check_any>
          </conditions>
          <actions>
            <include_actions ref="Get_Variables" />
            <set_value name="$params" exact="event.param" />
            <debug_text text="'PlayerPoi: Get_Actions resolved sector: %s, and POI: %s'.[@$sector, @$poi]" chance="$debugChance" filter="scripts" />
            <do_if value="@$sector != null">
              <set_value name="$sector" exact="event.param.$object" />
              <set_value name="$offset" exact="event.param.$offset" />
              <set_value name="$text" exact="{1972092414, 1011}.[$sector.knownname, ($offset.x/1000)i, ($offset.y/1000)i, ($offset.z/1000)i]" />
              <signal_cue_instantly
                cue="md.Interact_Menu_API.Add_Action"
                param="table[
                  $id             = 'player_poi_create_poi',
                  $section        = 'order',
                  $text           = $text,
                  $icon           = 'mapob_poi',
                  $mouseover      = $text,
                  $mouseover_icon = 'mapob_poi',
                  $active         = true,
                  $callback       = On_Create_POI_At_Point,
                ]" />
            </do_if>
            <do_elseif value="@$poi != null">
              <signal_cue_instantly
                cue="md.Interact_Menu_API.Add_Action"
                param="table[
                  $id             = 'player_poi_rename_poi',
                  $section        = 'order',
                  $text           = {1001, 1114},
                  $active         = true,
                  $callback       = On_Rename_POI,
                ]" />
            </do_elseif>
            <do_else>
              <run_actions ref="md.Player_POI.Is_POI_Assigned_On_Object" result="$isPoiAssigned">
                <param name="object" value="@event.param.$object" />
              </run_actions>
              <signal_cue_instantly
                cue="md.Interact_Menu_API.Add_Action"
                param="table[
                  $id             = 'player_poi_create_poi',
                  $section        = if @event.param.$object.isclass.{class.station} then 'interaction' else 'order',
                  $text           = {1972092414, 1012},
                  $icon           = 'mapob_poi',
                  $active         = $isPoiAssigned == false,
                  $callback       = On_Create_POI_On_Object,
                ]" />
              <remove_value name="$isPoiAssigned" />
            </do_else>
            <remove_value name="$sector" />
            <remove_value name="$poi" />
            <remove_value name="$params" />
          </actions>
        </cue>

        <cue name="On_Create_POI_At_Point" instantiate="true" version="1">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <include_actions ref="Get_Variables" />
            <debug_text text="'PlayerPoi: On_Create_POI_At_Point invoked with param: %s'.[event.param]" chance="$debugChance" filter="scripts" />
            <set_value name="$sector" exact="event.param.$object" />
            <set_value name="$offset" exact="event.param.$offset" />
            <do_if
              value="not $sector? or not $sector.isclass.{class.sector}">
              <debug_text text="'PlayerPoi: unable to resolve sector context.'"
                chance="$debugChance" filter="scripts" />
            </do_if>
            <do_else>
              <create_object name="$poi" owner="faction.player" macro="macro.player_poi_01_macro" sector="$sector">
                <position x="$offset.x" y="$offset.y" z="$offset.z" />
              </create_object>
              <do_if value="$poi? and @$poi != null">
                <set_value name="$name" exact="{1972092414, 111}.[$sector.knownname, ($offset.x/1000)i, ($offset.y/1000)i, ($offset.z/1000)i]" />
                <set_object_name object="$poi" name="$name" />
                <remove_value name="$name" />
              </do_if>
            </do_else>
            <remove_value name="$sector" />
            <remove_value name="$offset" />
          </actions>
        </cue>

        <cue name="On_Create_POI_On_Object" instantiate="true" version="1">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <include_actions ref="Get_Variables" />
            <debug_text text="'PlayerPoi: On_Create_POI_On_Object invoked with param: %s'.[event.param]" chance="$debugChance" filter="scripts" />
            <set_value name="$sector" exact="if event.param.$offsetcomponent != null then event.param.$offsetcomponent else event.param.$object.sector" />
            <set_value name="$object" exact="event.param.$object" />
            <do_if value="not $sector? or not $sector.isclass.{class.sector}">
              <debug_text text="'PlayerPoi: unable to resolve sector context.'"
                chance="$debugChance" filter="scripts" />
            </do_if>
            <do_else>
              <debug_text text="'PlayerPoi: creating POI on object %s in sector %s, with y: %s, size: %s, new y: %s'.[@$object, @$sector.knownname, $object.relativeposition.{$sector}.y, $object.size, $object.relativeposition.{$sector}.y + $object.size + 200m]" chance="$debugChance" filter="scripts" />
              <run_actions ref="md.Player_POI.Assign_POI_On_Object">
                <param name="object" value="$object" />
                <param name="prefix" value="{1972092414, 100}" />
              </run_actions>
            </do_else>
            <remove_value name="$sector" />
            <remove_value name="$object" />
          </actions>
        </cue>

        <cue name="On_Rename_POI" instantiate="true" version="1">
          <conditions>
            <event_cue_signalled />
          </conditions>
          <actions>
            <include_actions ref="Get_Variables" />
            <debug_text text="'PlayerPoi: On_Rename_POI invoked with param: %s'.[event.param]" chance="$debugChance" filter="scripts" />
            <raise_lua_event name="'PlayerPoi.OnRename'" param="@event.param.$object" />
          </actions>
        </cue>


      </cues>
    </cue>


  </cues>
</mdscript>